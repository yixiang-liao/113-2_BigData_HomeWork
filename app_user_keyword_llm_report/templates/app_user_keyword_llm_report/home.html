{% extends 'base.html' %}
{% block title %}
  使用者關鍵詞查詢
{% endblock %}
{% block content %}
  <div class="col-lg-12">
    <h1>分析你關心的關鍵詞:讓AI幫你自動產生分析報告</h1>
    <p>你可以自行修改使用不同的AI模型</p>
  </div>
  <div class="col-lg-6 mb-2">
    <!-- 輸入條件區塊開始 -->
    <div class="card">
      <div class="card-header">
        <h3 class="h6 text-uppercase mb-0">輸入條件</h3>
      </div>
      <div class="card-body">
        <div class="mb-3 row">
          <label class="col-md-3 col-form-label">關心哪個關鍵詞?</label>
          <div class="col-md-9">
            <input id="input_keyword" name="userkey" value="烏克蘭 俄羅斯" class="form-control" />
            <div class="form-text text-muted">全文搜尋關鍵字，可輸入多個，空白隔開。任何人名、產品、片語、特定詞皆可。</div>
          </div>
        </div>

        <div class="mb-3 row">
          <label class="col-sm-3 col-form-label">條件</label>

          <div class="col-md-9 mb-3">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cond_and" value="and" name="condradio" />
              <label class="form-check-label" for="cond_and">and</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cond_or" value="or" name="condradio" checked />
              <label class="form-check-label" for="cond_or">or</label>
            </div>
          </div>
        </div>

        <div class="mb-3 row">
          <label class="col-sm-3 col-form-label">新聞類別</label>
          <div class="col-md-9">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_all" value="全部" name="cateradio" checked />
              <label class="form-check-label" for="cate_all">全部</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_politics" value="政治" name="cateradio" />
              <label class="form-check-label" for="cate_politics">政治</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_tech" value="科技" name="cateradio" />
              <label class="form-check-label" for="cate_tech">科技</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_sports" value="運動" name="cateradio" />
              <label class="form-check-label" for="cate_sports">運動</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_stocks" value="證卷" name="cateradio" />
              <label class="form-check-label" for="cate_stocks">證卷</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_economy" value="產經" name="cateradio" />
              <label class="form-check-label" for="cate_economy">產經</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_entertainment" value="娛樂" name="cateradio" />
              <label class="form-check-label" for="cate_entertainment">娛樂</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_life" value="生活" name="cateradio" />
              <label class="form-check-label" for="cate_life">生活</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_international" value="國際" name="cateradio" />
              <label class="form-check-label" for="cate_international">國際</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_society" value="社會" name="cateradio" />
              <label class="form-check-label" for="cate_society">社會</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_culture" value="文化" name="cateradio" />
              <label class="form-check-label" for="cate_culture">文化</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="cate_china" value="兩岸" name="cateradio" />
              <label class="form-check-label" for="cate_china">兩岸</label>
            </div>
          </div>
        </div>
        <div class="mb-3 row">
          <label class="col-md-3 col-form-label">最近多少周?</label>
          <div class="col-md-9">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="wk1" value="1" name="wkradio" />
              <label class="form-check-label" for="wk1">1</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="wk2" value="2" name="wkradio"  checked/>
              <label class="form-check-label" for="wk2">2</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="wk3" value="3" name="wkradio" />
              <label class="form-check-label" for="wk3">3</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="wk4" value="4" name="wkradio" />
              <label class="form-check-label" for="wk4">4</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="wk6" value="6" name="wkradio" />
              <label class="form-check-label" for="wk6">6</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="wk8" value="8" name="wkradio" />
              <label class="form-check-label" for="wk8">8</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" id="wk12" value="12" name="wkradio"/>
              <label class="form-check-label" for="wk12">12</label>
            </div>
            <div class="form-text text-muted">以最新資料時間為準，往前推多少周?</div>
          </div>
        </div>
        <div class="mb-3 row">
          <div class="col-md-9 ms-auto">
            <button type="button" id="btn_ok" class="btn btn-primary">AI產生分析報告</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 輸入區塊結束 -->

  <!-- 顯示區塊開始 -->
  <div class="col-lg-12 mb-3">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">AI聲量分析報告</h4>
      </div>
      <div class="card-body markdown-body">
        <div id="chat_container" class="overflow-auto" style="height: 60vh; max-height: 500px;"></div>
      </div>
    </div>
  </div>

  <!-- 顯示區塊 -->
  <div class="col-lg-6 mb-2">
    <div class="card">
      <div class="card-header">
        <h3 class="h6 text-uppercase mb-0">出現頻率以時間呈現</h3>
      </div>
      <div class="card-body">
        <small>觀察每個時間點的有多少篇報導(聲量大小)</small>
        <div class="row">
          <canvas id="keyword_time_line_chart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <!-- 區塊結束 -->

  <!-- 同時出現的關鍵字區塊 -->
  <div class="col-lg-6 mb-2">
    <div class="card">
      <div class="card-header">
        <h3 class="h6 text-uppercase mb-0">熱門程度:有幾篇新聞報導提到它?</h3>
      </div>
      <div class="card-body">
        <ul id="keyword_article_count"></ul>
      </div>
    </div>
  </div>
  <!-- 區塊結束 -->


  <!-- 顯示區塊 -->
  <div class="col-lg-6 mb-5">
    <div class="card">
      <div class="card-header">
        <h3 class="h6 text-uppercase mb-0">情緒分析:文章層級</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <canvas id="article_senti_pie_chart"></canvas>
        </div>
        <div>
          <ul id="senti_info" class="list-unstyled d-flex flex-wrap justify-content-center gap-3 mt-4"></ul>
        </div>
      </div>
    </div>
  </div>
  <!-- 區塊結束 -->

  <!-- 顯示區塊 -->
  <div class="col-lg-6 mb-5">
    <div class="card">
      <div class="card-header">
        <h3 class="h6 text-uppercase mb-0">正反面情緒變化</h3>
      </div>
      <div class="card-body">
        <small>每個時間點的正反面報導的篇數(每天統計，6周含以上以5天為單位統計)</small>
        <div class="row">
          <canvas id="sentiment_time_line_chart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <!-- 區塊結束 -->

{% endblock %}
{% block extra_css %}
  <!-- GitHub Markdown CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css" />
{% endblock %}
{% block extra_js %}
  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- chartjs圖js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
  <!-- 程式碼區 -->
  <script>
    //**按鈕事件
    $('#btn_ok').on('click', function () {
      call_ajax()
      call_llm_report_generation_ajax()
    }) //event function
    

    function call_ajax() {
      const userkey = $('#input_keyword').val()
      const weeks = $("input[name='wkradio']:checked").val()
      const cate = $("input[name='cateradio']:checked").val()
      const cond = $("input[name='condradio']:checked").val()
    
      if (userkey.length < 2) {
        alert('輸入關鍵字不可空白或小於兩個中文字!')
        return 0
      }
    
    
      $.ajax({
        type: 'POST',
        url: 'api_get_userkey_data/',
        data: {
          userkey: userkey,
          cate: cate,
          weeks: weeks,
          cond: cond
        }, // pass to server
        success: function (received) {
          //若查無資料，顯示提醒訊息
          if (received['error']) {
            alert('檢索異常回應: ' + received['error'])
            return 0
          } 
          const article_count = received['key_occurrence_cat']
          $('#keyword_article_count').empty()
          //使用表格顯示，並設定交替行底色
          let tableHTML = `<table class="table table-striped"><thead><tr><th>關鍵詞</th><th>文章數量</th></tr></thead><tbody>`
          let index = 0
          for (let key in article_count) {
            tableHTML += `<tr><td>${key}</td><td>${article_count[key]}</td></tr>`
            index++
          }
          tableHTML += `</tbody></table>`
          $('#keyword_article_count').append(tableHTML)

          // 畫時間圖表
          const data_key_time_freq = received['key_time_freq']
          showtimechart(data_key_time_freq)

          // draw pie chart
          const data_pie = received['sentiCount']
          drawPieChart(data_pie)
    
          $('#senti_info').empty()
          for (let k in data_pie) {
            $('#senti_info').append(`<li class="badge bg-warning text-dark">${k}: ${data_pie[k]}篇</li>`)
          }
    
          // draw time-based line chart
          const data_pos = received['data_pos']
          const data_neg = received['data_neg']
    
          drawLineChart(data_pos, data_neg)

        } //function
      }) //ajax
    } //call_ajax()

    function call_llm_report_generation_ajax() {
      const userkey = $('#input_keyword').val()
      const weeks = $("input[name='wkradio']:checked").val()
      const cate = $("input[name='cateradio']:checked").val()
      const cond = $("input[name='condradio']:checked").val()
    
      if (userkey.length < 2) {
        alert('輸入關鍵字不可空白或小於兩個中文字!')
        return 0
      }
    
      // 清空聊天容器
      $('#chat_container').empty()
    
      // 添加"正在輸入"指示符
      let typingIndicator = addTypingIndicator()
    
      $.ajax({
        type: 'POST',
        url: 'api_get_userkey_llm_report/',
        data: {
          userkey: userkey,
          cate: cate,
          weeks: weeks,
          cond: cond
        }, // pass to server
        success: function (received) {
          // 移除"正在輸入"指示符
          typingIndicator.remove()
    
          //若查無資料，顯示提醒訊息
          if (received['error']) {
            alert('檢索異常回應: ' + received['error'])
            return 0
          }
    
          // 顯示AI報告
          if (received['report']) {
            report = received['report']
            //report = marked.parse(report)
            displayReport(report)
          }
    
        } //function
      }) //ajax
    } //call_ajax()
    
    // 添加"正在輸入"指示符
    function addTypingIndicator() {
      const indicatorHTML = `
                <div class="typing-indicator d-flex justify-content-start mb-3">
                  <div class="card bg-light" style="max-width: 75%;">
                    <div class="card-body py-2 px-3">
                      <div class="d-flex align-items-center">
                        <span class="spinner-grow spinner-grow-sm me-2" role="status" aria-hidden="true"></span>
                        <span>AI 正在思考，請耐心等候...</span>
                      </div>
                    </div>
                  </div>
                </div>
              `
    
      $('#chat_container').append(indicatorHTML)
      scrollToBottom()
    
      return $('.typing-indicator')
    }

    function displayReport(report) {
      // 使用 marked.js 將 markdown 轉為 HTML
      const renderedHTML = marked.parse(report)
      const reportHTML = `
            <div class="d-flex justify-content-start mb-3">
              <div class="card bg-light" style="max-width: 90%;">
                <div class="card-body py-2 px-3">
                  <div class="report-content">${renderedHTML}</div>
                </div>
              </div>
            </div>
          `
      $('#chat_container').append(reportHTML)
      scrollToBottom()
    }
    
    // 添加"正在輸入"指示符
    function addTypingIndicator() {
      const indicatorHTML = `
                <div class="typing-indicator d-flex justify-content-start mb-3">
                  <div class="card bg-light" style="max-width: 75%;">
                    <div class="card-body py-2 px-3">
                      <div class="d-flex align-items-center">
                        <span class="spinner-grow spinner-grow-sm me-2" role="status" aria-hidden="true"></span>
                        <span>AI 正在思考，請耐心等候...</span>
                      </div>
                    </div>
                  </div>
                </div>
              `
    
      $('#chat_container').append(indicatorHTML)
      scrollToBottom()
    
      return $('.typing-indicator')
    }
    
    // 滾動到底部
    function scrollToBottom() {
      const chatContainer = document.getElementById('chat_container')
      chatContainer.scrollTop = chatContainer.scrollHeight
    }
   
 
    // 宣告全域變數用於存放圖表實例
    let line_chart = null
    
    function showtimechart(data_key_time_freq) {
      //取得繪圖元件
      const ctx_key_time = document.getElementById('keyword_time_line_chart').getContext('2d')
    
      const myoptions = {
        type: 'line',
        data: {
          datasets: [
            {
              label: 's2',
              borderColor: 'red',
              data: data_key_time_freq // your data here!
            }
          ]
        },
        options: {
          legend: {
            display: false
          },
          scales: {
            xAxes: [
              {
                type: 'time',
                time: {
                  unit: 'day',
                  displayFormats: {
                    //day: 'DD-MM-YYYY'
                    day: 'MM/DD'
                  }
                }
              }
            ],
            yAxes: [
              {
                ticks: {
                  beginAtZero: true
                },
                display: true,
                scaleLabel: {
                  display: true,
                  labelString: '出現次數'
                }
              }
            ]
          }
        }
      }
    
      // 檢查並清除舊圖
      if (line_chart) {
        line_chart.destroy()
      }
    
      // 畫新圖
      line_chart = new Chart(ctx_key_time, myoptions)
    }



    
    let sentiment_bar_chart = null;
    // PieChart function寫法
    function drawPieChart(chartdata) {
      // pie chart
      let piechartElem = document.getElementById('article_senti_pie_chart').getContext('2d')
      let chartSpec = {
        type: 'pie',
        data: {
          labels: ['正面', '負面', '中立'],
          datasets: [
            {
              data: [chartdata.Positive, chartdata.Negative, chartdata.Neutral],
              backgroundColor: ['rgba(0,0,255,0.3)', 'rgba(255,0,0,0.3)', 'rgba(150,150,150,0.3)']
            }
          ]
        },
        options: {}
      }

      // 檢查並清除舊圖
      if (sentiment_bar_chart) {
        sentiment_bar_chart.destroy()
      }

      // 畫新圖
      sentiment_bar_chart = new Chart(piechartElem, chartSpec)
    }
    
    let sentiment_line_chart = null;
    // Line chart function
    function drawLineChart(data_pos, data_neg) {

      linechartElem = document.getElementById('sentiment_time_line_chart').getContext('2d')
      // for positive sentiment line chart
      let dataPos = {
        label: '正面',
        data: data_pos,
        borderColor: 'rgba(0,0,255,0.3)', //"blue", //藍色表示正面
        backgroundColor: 'rgba(0,0,255,0.2)', //背景顏色
        borderWidth: 1,
        fill: true
      }
      // for negative sentiment line chart
      let dataNeg = {
        label: '負面',
        data: data_neg,
        borderColor: 'rgba(255,0,0,0.3)', //"red", //紅色表示負面
        backgroundColor: 'rgba(255,0,0,0.2)', //背景顏色
        borderWidth: 1,
        fill: true
      }
    
      let options_detail = {
        legend: {
          display: true
        },
        scales: {
          xAxes: [
            {
              type: 'time',
              time: {
                unit: 'day',
                displayFormats: {
                  //day: 'DD-MM-YYYY'
                  day: 'MM/DD'
                }
              }
            }
          ],
          yAxes: [
            {
              ticks: {
                beginAtZero: true
              },
              display: true,
              scaleLabel: {
                display: true,
                labelString: '篇數'
              }
            }
          ]
        }
      }
    
      let chart_spec = {
        type: 'line',
        data: {
          datasets: [dataPos, dataNeg] //有兩條線，兩組資料使用陣列存放即可
        },
        options: options_detail
      }
    
      // now draw the sentiment line chart
      if (sentiment_line_chart)
         sentiment_line_chart.destroy();
      return new Chart(linechartElem, chart_spec)
    }


  </script>
{% endblock %}
